<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocal Amplifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation; /* Improves touch response */
        }
        
        /* Custom range slider styling for iPad touchability */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -14px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #374151;
            border-radius: 4px;
        }

        .visualizer-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #1f2937;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        /* Pulse animation for the live indicator */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .live-dot {
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-between p-6">

    <!-- Header -->
    <div class="w-full text-center space-y-2">
        <h1 class="text-3xl font-bold tracking-tight text-blue-400">Vocal Lift</h1>
        <p class="text-gray-400 text-sm">Personal Amplifier Tool</p>
    </div>

    <!-- Main Content Area -->
    <div class="w-full max-w-lg flex-1 flex flex-col justify-center space-y-8">
        
        <!-- Status / Error Message Display -->
        <div id="statusMessage" class="hidden p-4 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-200 text-center text-sm">
            Ready to connect.
        </div>

        <!-- Visualizer -->
        <div class="visualizer-container border border-gray-700">
            <canvas id="visualizer" class="w-full h-full"></canvas>
            <div id="liveIndicator" class="absolute top-4 right-4 bg-black/50 px-3 py-1 rounded-full text-xs font-bold text-white hidden flex items-center">
                <span class="live-dot"></span> LIVE
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
            
            <!-- Volume Slider -->
            <div class="mb-8">
                <div class="flex justify-between mb-4">
                    <label for="gainControl" class="text-lg font-medium text-gray-300">Boost (Volume)</label>
                    <span id="gainValue" class="text-blue-400 font-bold font-mono">100%</span>
                </div>
                <input type="range" id="gainControl" min="0" max="300" value="100" step="5" disabled>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>Mute</span>
                    <span>Normal</span>
                    <span>Max</span>
                </div>
            </div>

            <!-- Toggle Button -->
            <button id="toggleBtn" class="w-full py-6 rounded-xl text-xl font-bold transition-all transform active:scale-95 shadow-lg bg-blue-600 hover:bg-blue-500 text-white border-b-4 border-blue-800 active:border-b-0 active:mt-1">
                Start Microphone
            </button>
        </div>
    </div>

    <!-- Instructions / Footer -->
    <div class="w-full max-w-lg text-center pb-4 text-xs text-gray-500 space-y-1">
        <p>⚠️ Warning: Keep microphone away from speakers to avoid feedback.</p>
        <p>Ensure iPad "Silent Mode" is OFF and volume is UP.</p>
    </div>

    <script>
        // DOM Elements
        const toggleBtn = document.getElementById('toggleBtn');
        const gainControl = document.getElementById('gainControl');
        const gainValue = document.getElementById('gainValue');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const statusMessage = document.getElementById('statusMessage');
        const liveIndicator = document.getElementById('liveIndicator');

        // Audio Context Variables
        let audioContext = null;
        let microphoneStream = null;
        let gainNode = null;
        let analyzer = null;
        let isRunning = false;
        let animationId = null;

        // Resize canvas to match display size for crisp rendering
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Helper: Show status messages
        function showStatus(msg, type = 'info') {
            statusMessage.textContent = msg;
            statusMessage.classList.remove('hidden', 'bg-red-900/50', 'border-red-700', 'text-red-200', 'bg-yellow-900/50', 'border-yellow-700', 'text-yellow-200');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-900/50', 'border-red-700', 'text-red-200');
            } else {
                statusMessage.classList.add('bg-yellow-900/50', 'border-yellow-700', 'text-yellow-200');
            }
            statusMessage.classList.remove('hidden');
        }

        // Initialize Audio
        async function startAudio() {
            try {
                // 1. Create Audio Context (must be done on user gesture)
                if (!audioContext) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext({
                        latencyHint: 'interactive' // Request lowest possible latency
                    });
                }

                // Resume context if suspended (common in iOS)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // 2. Request Microphone Access
                // Important: echoCancellation: false ensures we get raw audio and don't trigger
                // iOS's built-in feedback suppression which lowers volume.
                const constraints = {
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        latency: 0
                    }
                };

                microphoneStream = await navigator.mediaDevices.getUserMedia(constraints);

                // 3. Create Nodes
                const source = audioContext.createMediaStreamSource(microphoneStream);
                gainNode = audioContext.createGain();
                analyzer = audioContext.createAnalyser();

                // 4. Configure Analyzer (Visualizer)
                analyzer.fftSize = 2048;

                // 5. Connect Graph: Source -> Gain -> Analyzer -> Destination (Speakers)
                source.connect(gainNode);
                gainNode.connect(analyzer);
                gainNode.connect(audioContext.destination);

                // 6. Set initial volume based on slider
                const sliderVal = parseFloat(gainControl.value) / 100;
                gainNode.gain.value = sliderVal; // 1.0 is 100%

                // 7. Update UI
                isRunning = true;
                toggleBtn.textContent = "Stop Microphone";
                toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'border-blue-800');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-500', 'border-red-800');
                gainControl.disabled = false;
                liveIndicator.classList.remove('hidden');
                statusMessage.classList.add('hidden');

                // 8. Start Visualizer
                visualize();

            } catch (err) {
                console.error("Error accessing microphone:", err);
                showStatus("Error: Could not access microphone. Please ensure permissions are allowed in Settings.", "error");
                stopAudio();
            }
        }

        function stopAudio() {
            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
                microphoneStream = null;
            }
            if (audioContext) {
                audioContext.suspend();
            }
            
            isRunning = false;
            cancelAnimationFrame(animationId);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // UI Reset
            toggleBtn.textContent = "Start Microphone";
            toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'border-blue-800');
            toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-500', 'border-red-800');
            gainControl.disabled = true;
            liveIndicator.classList.add('hidden');
        }

        // Toggle Button Handler
        toggleBtn.addEventListener('click', () => {
            if (isRunning) {
                stopAudio();
            } else {
                startAudio();
            }
        });

        // Gain/Volume Handler
        gainControl.addEventListener('input', (e) => {
            const val = e.target.value;
            gainValue.textContent = val + "%";
            
            if (gainNode) {
                // Convert percentage to gain value (100% = 1.0)
                // We allow going up to 300% (3.0 gain) for software boost
                gainNode.gain.value = val / 100;
            }
        });

        // Visualizer Loop
        function visualize() {
            if (!isRunning) return;

            const bufferLength = analyzer.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            analyzer.getByteTimeDomainData(dataArray);

            ctx.fillStyle = '#1f2937'; // Match container background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 3;
            ctx.strokeStyle = '#60a5fa'; // Blue-400
            ctx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0; // Normalize 0-255 to 0-2 range (1 is center)
                const y = v * canvas.height / 2;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            animationId = requestAnimationFrame(visualize);
        }
    </script>
</body>
</html>